## 3.5 메모리를 할당할 때 저수준 계층에서 일어나는 일

### 3.5.1 천지인과 CPU 실행 상태

- 컴퓨터 시스템에는 여러 특권 단계가 존재한다. x86 CPU는 0~3까지 네 단계의 특권 레벨을 제공하며, 숫자가 낮을수록 권한이 높다
- CPU 특권 단계는 Ring 0(커널)부터 Ring 3(응용 프로그램)까지 네 단계가 있다. 
  - **Ring 0**: 커널 상태, 가장 높은 권한을 가짐
  - **Ring 3** : 사용자 상태 (일반적인 프로그램 실행) 

### 3.5.2 커널 상태와 사용자 상태

- 운영 체제의 코드는 커널 상태(Ring 0)에서 실행되어 모든 하드웨어와 주소 공간에 접근할 수 있다. 반면, 일반 프로그램은 사용자 상태(Ring 3)에서 실행되어 제한된 명령만 사용할 수 있다
- 사용자 상태에서 운영 체제 영역에 접근하려 하면 오류(segmentation fault)가 발생한다. 사용자 상태에서는 특권 명령을 실행할 수 없다

### 3.5.3 포털: 시스템 호출

- 응용 프로그램이 운영 체제의 서비스를 사용하려면 시스템 호출(System Call)을 사용해야 한다.
- 시스템 호출은 일반적인 응용 프로그램이 직접 하드웨어나 커널의 자원을 접근하지 못하게 하고, 운영 체제의 통제를 받도록 만든 장치다.
- 시스템 호출은 보통 CPU의 특수 명령어(INT 명령 등)를 통해 커널 모드로 전환하여 실행된다.
  - 파일을 읽거나 쓰고, 네트워크 통신을 할 때 시스템 호출이 사용된다.
- 그림 3-60은 시스템 호출이 사용자 상태에서 커널 상태로 전환되어 처리되는 과정을 보여준다.


### 3.5.4 표준 라이브러리: 시스템의 차이를 감춘다

- 시스템 호출을 직접 사용하면 운영 체제마다 차이가 발생하므로, 이를 표준 라이브러리가 감춰준다.
- 표준 라이브러리는 응용 프로그램과 운영 체제 사이에서 중간 역할을 하며, 운영 체제의 시스템 호출을 간접적으로 사용하게 해준다.
- C 언어의 표준 라이브러리가 대표적이며, 파일 입출력, 메모리 할당, 네트워크 등 여러 기능을 제공한다.
- 표준 라이브러리를 사용하면 운영 체제에 따라 소스 코드를 크게 바꾸지 않고도 프로그램을 작성할 수 있다.


### malloc과 표준 라이브러리의 관계
- malloc 같은 메모리 할당 함수도 표준 라이브러리의 일부로 구현되어 있다.
- 다양한 종류의 메모리 할당자가 존재하며, 상황에 따라 적합한 할당자를 선택하는 것이 중요하다.


### 3.5.5 힙 영역의 메모리가 부족할 때
- 프로세스의 주소 공간에서 힙과 스택 사이에는 여유 공간이 있다. 힙 영역이 부족하면 운영 체제에 메모리를 요청해 힙을 확장한다.
- malloc이 메모리 조각을 찾지 못하면 운영 체제의 brk 시스템 호출로 힙 영역을 늘린다. 
  - 이 과정은 malloc이 내부적으로 관리하며, 여유 메모리 조각이 생기면 다시 할당에 사용한다.

### 3.5.6 운영체제에 메모리 요청하기 : brk
- 메모리 할당 단계는 malloc 호출 → 여유 메모리 조각 탐색 → 없으면 brk로 메모리 요청 → 다시 할당 순서로 진행된다.

### 3.5.7 가상 메모리가 최종 보스다
- 기존 우리가 알고 있던 방법 
  - malloc으로 메모리를 요청하면 운영 체제에 영역 확장을 요청하고, 다시 여유 메모리 조각을 찾아 사용자에게 반환한다.
  - 가상 메모리를 지원하는 시스템에서는 이런 과정 X!
- 가상 메모리를 지원하는 시스템에서는 실제 물리 메모리가 언제 할당되는지 명확하지 않고, malloc으로 영역을 할당받아도 실제로는 가상 메모리만 할당된 상태일 수 있다.
- 실제 물리 메모리는 해당 영역을 처음 사용할 때 할당되며, 이때 페이지 폴트가 발생해 운영 체제가 실제 물리 메모리와 연결한다. 
- malloc은 2차 할당 과정을 거치며, 이 과정은 모두 사용자 상태에서 처리된다. 프로그램이 할당한 가상 메모리는 반드시 실제 물리 메모리와 사상 관계에 있어야 하며, 운영 체계가 이를 관리한다.

### 3.5.8 메모리 할당의 전체 이야기
1. malloc이 여유 조각을 검색해 할당한다.
2. 여유 메모리 조각이 없으면 brk 같은 시스템 호출로 힙 영역을 확장한다. 
3. malloc이 brk를 호출하면 커널 상태로 전환, 이때 운영체제 가상 메모리 시스템이 힙 영역을 확장한다.
4. brk 실행 종료 후 malloc으로 제어권이 돌아가고, CPU도 사용자 상태로 전환된다.
5. malloc이 적절한 여유 메모리 조각을 찾아 반환한다.
6. 코드가 새로 요청된 메모리를 사용하면, 시스템 내에서 페이지 폴트 인터럽트가 발생하고 이때 실제 물리 메모리가 할당된다.
