## CPU의 분기 예측
### likely, unlikely 매크로 함수
- CPU의 분기 예측 정확도를 높이기 위한 힌트용 매크로
  - 분기 예측 힌트를 컴파일러에게 제공한다. 

```java
// 여기서 x는 조건문
#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)
```
리눅스 커널 코드에서는 `likely`와 `unlikely`를 통해 컴파일러에 **분기 예측 힌트를 제공**한다. 
- 이 매크로들은 내부적으로 GCC의 `__builtin_expect` 를 호출해, x가 참/거짓일 가능성이 높다는 정보를 컴파일 단계에서 반영하도록 한다. 
- 정상 경로에 `likely`, 오류나 특수 경로에 `unlikely`를 걸어둔다. 
- 위 매크로를 통해, 컴파일 타임에 코드 재배치를 통해 핫 패스 (자주 사용되는)를 인접 메모리 영역에 모아 캐시 지역성을 높인다.
  - 예상 경로가 코드 상에서 연속적으로 배치되도록 하는 것!

### 실제 분기 예측
실제 런타임에서 분기를 예측하는 것은 CPU의 **동적 예측기**이다.
- 초기 예측이 필요한 상태에서는 likely/unlikely로 삽입된 예측 힌트가 사용된다. (정적 예측)
- 이후 런타임 이력이 쌓이면 동적 예측기가 이력을 기반으로 최종 결정을 내린다.


### 하지만 최신 CPU에서는...
최신 CPU는 약 95% 이상의 분기 예측 정확도를 달성하기 때문에, 파이프라인 플러시로 인한 성능 손실이 최소화되었다.
- 여러 유형의 동적 예측기를 조합해, 각 분기에 특성에 맞게 활용
- 런타임 동안 실시간 학습

힌트 기반의 `likely`/`unlikely` 역할은 점점 줄어들고 문서화, 디버깅 편의 용도로 추천되고 있다!
