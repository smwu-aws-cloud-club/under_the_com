# 2.3 스레드 안전 코드는 도대체 어떻게 작성해야 할까?

## 2.3.1 자유와 제약

- 공공 자원을 사용할 때 적용되는 제약

1. 전용 리소스를 사용하는 스레드는 스레드 안전 달성
2. 공유 리소스를 사용하는 스레드는 다른 스레드에 영향을 주지 않도록 하는 대기 제약 조건에 맞게 사용하면 스레드 안전 달성

## 2.3.2 스레드 안전이란 무엇일까?

- 코드가 스레드 몇 개에서, 어떤 순서로 호출되든 상관 없이 올바른 결과가 나옴
- 전용/공유 리소스가 어떤 거이 있는지 파악해야 함

## 2.3.3 스레드 전용 리소스와 공유 리소스

- 스레드 전용 리소스 = 함수의 지역 변수, 스레드의 스택 영역, 스레드 전용 저장소
- 공유 리소스 = 그 외 영역

  - 힙 영역
  - 데이터 영역
  - 코드 영역: 읽기 전용이라 수정할 방법이 없어 신경 쓸 필요 X

- 스레드는 반드시 순서를 따라야 함
  - 공유 리소스를 사용하는 작업이 다른 스레드를 방해할 수 없음
  - 이를 위해 잠금lock이나 세마포어Semapore 같은 장치 사용 가능
  - 목적: 공유 리소스 순서 유지

## 2.3.4 스레드 전용 리소스만 사용하기

**무상태 함수**

- 전역 변수나 매개변수에 의존하지 않고 지역변수만 사용

## 2.3.5 스레드 전용 리소스와 함수 매개변수

- 값으로 전달(call by value)라면 문제 없음
  - 값으로 전달된 매개변수는 스레드 전용 리소스
  - 스택 영역에 저장됨
- 포인터 전달
  - 전역 변수를 가리키키는 경우
  - 잠금과 같은 형태의 순서가 반드시 부여되어야 함
    → 스레드가 함수를 호출할 때 해당 스레드에 속하는 리소스 주소를 전달하면 해결 가능

## 2.3.6 전역 변수 사용

- 변수를 읽기만 하면 문제 없음
- 전역 변수의 변경 과정은 반드시 잠금 등의 보호 또는 덧셈 작업을 원자성(atomic) 작업으로 설정해서 보호해야 함

## 2.3.7 스레드 전용 저장소

- \_\_thread 수식어가 붙은 변수는 스레드 전용 저장소에 배치됨
  → 스레드 안전

## 2.3.8 함수 반환값

- 값을 반환하는 경우 → 안전
- 포인터를 반환하는 경우 → 안전 X
  - 정적 지역 변수의 주소 반환 시 잠재적으로 스레드 공유 리소스가 됨
  - 싱글톤 패턴 구현할 수 있으면 OK

## 2.3.9 스레드 안전이 아닌 코드 호출하기

- 잠금으로 보호하면 스레드 안전
  - 전역 변수를 간접적으로 보호하기 때문
- 전달된 매개변수가 스레드 전용 리소스인 지역 변수라면 안전

## 2.3.10 스레드 안전 코드는 어떻게 구현할까?

- 어떤 리소스를 공유해야 하는지 고려 필요
- 다중 스레드 프로그래밍 중에는 최대한 공유하지 않는 것이 원칙
- 어떤 것이 스레드 전용/공유 리소스인지 파악할 필요 있음
  - 스레드 전용 저장소
  - 읽기 전용
  - 원자성 연산
  - 동기화 시 상호 배제
