# 6.2 디스크가 입출력을 처리할 때 CPU가 하는 일은 무엇일까?

> 디스크가 입출력을 처리할 때 CPU 개입이 필요하지 않다. 디스크가 입출력 요청을 처리하는 동안 운영 체제는 CPU가 다른 작업을 수행하도록 스케줄링한다.

> 예. CPU가 스레드 1을 실행하기 시작하고 일정 시간이 지난 후 파일 읽기와 같은 디스크 관련 입출력을 요청한다.

1. 디스크 입출력은 CPU 속도에 비해 매우 느리다. 입출력 요청의 처리가 완료되기 전까지 스레드 1은 진행 불가.
2. 스레드 1의 실행은 일시 중지되고, CPU가 준비 완료 상태인 스레드 2에 할당되낟.
3. 디스크가 입출력 요청의 처리를 완료하면 CPU는 스레드 1을 이어서 실행한다.

## 6.2.1 장치 제어기

디스크와 같은 입출력 장치는 대체로 **기계 부분, 전자 부분** 두 개의 부분으로 나눌 수 있다.

**기계 부분**

눈에 보이고 만질 수 있다. 입출력 요청이 들어왔을 때 읽어야 하는 데이터가 헤드가 위치한 트랙(track)에 없을 가능성이 있다. 이러면 헤드가 특정 트랙으로 이동해야 하고, 이 과정을 **탐색(seek)** 이라고 한다. 이 작업은 기계 장치를 직접 움직이기 때문에 CPU 속도와 비교해 극도로 느려 디스크 입출력 중에서 매우 시간을 많이 소모하는 작업에 해당한다.

**전자 부분**

전자 부분은 전자 부품으로 구성되어 있으며, 이를 장치 제어기(device controller)라고 한다. 자체적인 프로세서와 펌웨어(firmware)를 갖추고 있어, CPU가 없이도 복잡한 작업을 할 수 있으며, 동시에 자신만의 버퍼나 레지스터를 갖추고 있어 장치에서 읽은 데이터나 장치에 저장할 데이터를 저장할 수 있다.

장치 드라이버(device driver)는 운영 체제에 속한 코드이고, 장치 제어기는 장치 드라이버에서 명령을 받아 외부 장치를 제어하는 하드웨어이며, 운영 체제에 해당하는 장치 드라이버와 외부 장치를 연결하는 다리에 해당한다.


## 6.2.2 CPU가 직접 데이터를 복사해야 할까?

> CPU가 데이터를 직접 복사하는 것은 계산 리소스를 낭비하는 일이다.

**직접 메모리 접근(direct memory access, DMA)** 는 CPU 개입이 없는 상황에서 직접 장치와 메모리 사이에 데이터를 전송할 수 있는 작동 방식이다. 이를 사용한다.

## 6.2.3 직접 메모리 접근

CPU는 명령을 내려서 일을 수행하도록 시킨다. 이때 DMA가 메모리와 외부 장치 사이에서 데이터를 이동시키는 역할을 한다. 즉, CPU 개입 없이 장치와 메모리 사이에 직접 데이터를 전송한다.

**동작 과정**

1. CPU가 어떻게 데이터를 복사할지 알려 주는 명령어를 DMA에 전달한다.
  - 메모리에서 장치로 데이터를 기록할지 아니면 그 반대인지
  - 데이터를 얼마나 기록해야 할지
  - 어느 메모리 위치에서 데이터를 읽어야 하는지
  - 어떤 장치에서 데이터를 읽고 쓸지
2. DMA는 자신의 작업 목표를 명확히 하고 버스 중재(bus arbitration), 버스의 사용 권한을 요청하고 장치를 작동시킨다.
  - 디스크에서 데이터를 읽는다고 가정하면, 장치 제어기의 버퍼에서 데이터를 읽으면 DMA가 지정된 메모리 주소에 데이터를 쓰는 방식으로 데이터 복사가 완료된다.
  - 메모리에서 장치로 데이터를 쓰는 과정도 동일하다.

**문제**

> 장치에서 읽은 데이터를 메모리에 저장한다고 하면 DMA는 읽은 데이터를 가상 주소와 물리 메모리 주소 중 어느 쪽에 저장해야 할까?

→ 운영 체제가 DMA에 필요한 가상 주소와 물리 메모리 주소 사이의 사상 정보를 제공함으로써 해결할 수 있다. DMA가 가상 주소를 기반으로 직접 데이터를 전송할 수 있게 된다.

> 캐시가 존재하는 시스템에서는 때에 따라 메모리와 캐시의 데이터가 서로 동일하지 않을 수 있다. 

→ 캐시에 갱신되었지만, 아직 a 변수의 최신 값은 메모리에 갱신되지 않았을 때, 일관성 문제가 발생한다. 이는 상응하는 캐시의 데이터를 즉시 메모리에 갱신해 해결할 수 있다.

> CPU는 데이터 전송이 완료 되었는지 어떻게 알 수 있을까?

→ DMA가 데이터 전송을 완료하면 인터럽트 작동 방식을 사용하여 CPU에게 알려준다.

## 6.2.4 전 과정 정리

> 디스크가 입출력 요청을 처리할 때 CPU가 기다리지 않고 다른 일을 처리한다.

CPU로 실행되는 스레드 1이 시스템 호출로 입출력 요청을 시작한다.

→ 운영 체제는 스레드 1의 실행을 일시 중지하고 CPU를 스레드 2에 할당한다.

→ 스레드 2가 실행된다.

→ 이때 디스크가 동작하여 데이터 준비가 완료되면 DMA 작동 방식이 직접 장치와 메모리 사이에서 데이터를 전송한다.

→ 이 데이터 전송이 완료되면 인터럽트 작동 방식을 이용하여 CPU에 알린다.

→ CPU는 스레드 2의 실행을 일시 중지하고 인터럽트를 처리한다.

→ 운영 체제는 스레드 1이 요청한 입출력 작업이 처리된 것을 확인했기 때문에 CPU를 다시 스레드 1에 할당하기로 결정한다

→ 스레드 1이 마지막으로 중단되었던 위치부터 계속 실행된다.

## 6.2.5 프로그래머에게 시사하는 것

> 동기와 비동기 관점

사실상 비동기이기에 디스크가 입출력 요청을 처리하는 동안 CPU는 자신의 업무를 처리를 한다.

> 소프트웨어 관점

디스크의 입출력 요청 처리를 하나의 단독 스레드로 간주하고, CPU가 기계 명령어를 실행하는 것도 또 하나의 단독 스레드로 간주할 수 있다.

높은 효율성을 이끌어내기 위해 사용되는 것이 비동기이다. **무의존성** 또는 **분리(decoupling)** 가 이에 해당한다. 상대적으로 독립적일 때만 시스템의 리소스를 더 효율적으로 사용한다.