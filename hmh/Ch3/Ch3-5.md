## 3.5 메모리를 할당할 때 저수준 계층에서 일어나는 일

**코드 등급**

- CPU는 네 가지 특권 단계 제공한다.
- 숫자가 작을수록 CPU의 특권은 커진다.
- 특권: 일부 명령어를 실행할 수 있는지를 나타낸다.
- 일부 기계 명령어는 CPU가 가장 높은 특권상태일 때만 실행 가능하다.
- 일반적으로 시스템은 CPU의 특권 단계 중 0, 3 두 단계만 사용한다.
  - 3단계 = 사용자 상태 `user mode`
  - 0단계 = 커널 상태 `kernal mode`

### 3.5.1 천지인과 CPU 실행 상태

### 3.5.2 커널 상태와 사용자 상태

**커널 상태**

- CPU가 운영체제의 코드를 실행할 때
- CPU는 모든 기계 명령어를 실행할 수 있고 모든 주소 공간에 접근할 수 있다.
- 제한 없이 하드웨어에 접근할 수 있다.

**사용자 상태**

- 프로그래머가 작성한 일반적인 코드를 CPU가 사용할 때
- 특정 주소 공간에는 절대 접근할 수 없다.
- 만약 접근하려고 한다면 세그먼테이션 오류가 발생한다.
- 특권 명령어를 실행할 수 없다.
- 일반적인 응용 프로그램은 사용자 상태에 놓인다.

### 3.5.3 포털: 시스템 호출

**시스템 호출**

- 이를 통해서 운영체제 서비스를 요청할 수 있다.
- 시스템 호출은 x86에 인트 명령어처럼 특정한 기계 명령어로 구현된다.
- 명령어를 실행하면 CPU는 사용자 상태에서 커널 상태로 전환되고 운영체제의 코드를 실행하는 방법으로 요청을 수행한다.
- 프로세스-클라이언트 / 운영 체제-서버 / 시스템 호출-네트워크 요청에 비할 수 있다.

### 3.5.4 표준 라이브러리: 시스템의 차이를 감춘다

**표준 라이브러리**

- 시스템 호출을 직접 사용하면 리눅스의 프로그램은 윈도우에서 직접 실행할 수 없게 된다.
- 따라서 사용자에게서 저 수준 계층간 차이를 감추는 일정의 표준이 필요하다.
- C 언어에서 이 일을 하는 것이 표준 라이브러리
- 표준 라이브러리의 코드는 사용자 상태에서도 실행된다.
- 표준 라이브러리는 실행 중인 응용 체제에 따라 대응되는 시스템 호출을 선택한다.
- 응용 프로그램은 표준 라이브러리만 의사소통 대상으로 간주한다.
- 표준 라이브러리는 시스템 호출로 운영체제와 소통하며 운영체제는 저 수준 하드웨어를 관리한다.
- 메모리 할당자는 표준 라이브러리에 일부로 구현되어 있다. ⇒ 메모리 할당과의 관계성

### 3.5.5 힙 영역의 메모리가 부족할 때

> 여유 메모리 조각이 부족해지면 어떻게 해야 할까?

- 메모리가 부족해지면 운영체제의 메모리를 요청한다.
- brk 변수
  - 힙 영역의 최상단을 가리킨다.
  - 브레이크 변수 값을 위로 이동해서 힘 영역을 확정하려면 시스템 호출이 필요하다.
  - 운영체제에 메모리 요청하기 brk시스템 호출을 이용하여 조절하는 방식으로 힙 영역을 늘리거나 줄일 수 있다.

### 3.5.6 운영 체제에 메모리 요청하기: brk

> 시스템 호출이 있으므로 힙 영역이 부족하면, 즉시 운영체제의 힘 영역을 늘릴 것을 요청할 수 있고 이것보다 더 많은 여유 메모리를 확보할 수 있다.

**메모리 할당 단계**

- 프로그램은 malloc을 호출하여 메모리 할당을 요청한다. (malloc은 표준 라이브러리에 구현됨)
- malloc은 유휴 메모리 조각을 검색하기 시작하고 적절한 크기에 조각 찾으면 이를 할당한다.
  - 여기까지는 사용자 단계에서 처리된다.
- malloc이 여유 메모리 조각을 찾지 못하면 브레이크 시스템 호출 등을 통해 운영체제의 힙 영역을 늘려달라고 요청한다.
  - brk는 운영체제의 일부분이므로 커널 상태에 놓여 있다.
  - 힘 영역이 늘어나면 malloc이 다시 한 번 적절한 여유 메모리 조각을 찾아서 할당한다.

### 3.5.7 빙산의 아래: 가상 메모리가 최종 보스다

> 힙 영역을 포함한 전체 프로세스 주소 공간은 모두 실제 물리 메모리가 아니다.

**가상 메모리**

- 프로세스 입장에서 사용하는 메모리는 모두 가상이다. → 가상 메모리 시스템으로 유지된다.
- 실제로 할당한 메모리가 사용되는 순간에 물리 메모리를 할당하게 된다.
- 연결되어 있지 않으면 내부적으로 페이지 누락 오류가 발생할 수 있다.
- 운영체제가 오류를 감지하여 페이지 테이블을 수정해 가상과 실제 물리 메모리의 사상 관계를 설정한다. → 프로그램에서 할당받은 메모리를 사용할 수 있다
- malloc은 메모리의 2차 할당에 불과하며 그마저도 가상 메모리에 불과하다.
  - 이 과정은 모두 사용자 상태에서 처리된다.
- 프로그램이 할당된 가상 메모리를 사용할 때 반드시 사상과 사상 관계가 있어야 하며 커널 상태에서 실제 물리 메모리가 할당된다. 운영체제만 실제 물리 메모리를 할당할 수 있다.

### 3.5.8 메모리 할당의 전체 이야기

1. malloc이 여유 메모리 조각각을 검색하고 적절한 크기의 조각을 찾으면 반환한다.
2. 찾지 못하면 brk 같은 시스템 호출을 통해 힙 영역을 확장해 더 많은 여유 메모리를 얻는다.
3. brk 호출로 커널 상태로 전환되고 OS의 가상 메모리 시스템이 힙 영역을 확장한다.
   1. 확장된 메모리 영역은 가상 메모리에 불과하다.
   2. 아직 실제 물리 메모리를 할당하지 않았을 수 있다.
4. brk 실행이 종료되면 커널 → 사용자 상태로 전환된다. malloc이 메모리 조각을 반환한다.
5. 메모리를 성공적으로 요청해 다음 단계를 실행한다.
6. 페이지 누락 인터럽트가 발생한다. → 커널 상태로 전환되며 사상 관계를 설정하고 다시 사용자 상태로 돌아가 다음 처리로 넘어간다.
