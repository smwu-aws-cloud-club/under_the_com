# 2.2 스레드 간 공유되는 프로세스 리소스

프로세스와 스레드의 차이점은 무엇일까?<br>
사전적으로 정의하면 "프로세스는 운영 체제가 리소스를 할당하는 기본 단위고, 스레드는 스케줄링의 기본 단위이며, 프로세스 리소스는 스레드 간에 공유된다"고 할 수 있다.<br>
그렇다면 스레드 전용 리소스에는 무엇이 있을까?

## 2.2.1 스레드 전용 리소스

![스레드와 스택 영역](https://oopy.lazyrockets.com/api/v2/notion/image?src=https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F22402d14-7a39-4c03-b030-d9639ef77009%2FUntitled.png&blockId=5bccb2c0-1507-42e8-94fe-7c886f243d54)<br>
상태 변화 관점에서 보면 스레드는 함수 실행이고, 시작점으로 진입 함수(main)를 사용한다.<br>
함수의 실행 시간 정보는 스택 영역을 구성하는 스택 프레임에 저장된다.<br>
각 스레드는 자신만 사용할 수 있는 스택 영역을 가지므로 스레드 여러 개가 있을 때는 여러 스택 영역이 존재하게 된다.<br>
스레드에 속한 스택 영역, 프로그램 카운터, 스택 포인터, 함수 실행 시 사용되는 레지스터 정보를 통틀어 **스레드 상황 정보**라고 하고, 해당 스레드만 사용할 수 있는 전용 스레드 상황 정보이다.<br>
스레드는 프로세스 주소 공간에서 스택 영역을 제외한 나머지 영역을 모두 공유한다.<br>

## 2.2.2 코드 영역: 모든 함수를 스레드에 배치하여 실행할 수 있다

프로세스의 코드 영역에는 프로그래머가 작성한 코드를 컴파일한 후 생성된 실행 가능한 기계 명령어가 저장된다.<br>
코드 영역은 스레드 간에 공유되므로 어떤 함수든지 모두 스레드에 적재하여 실행할 수 있다.<br>
코드 영역은 읽기 전용이므로 프로그램이 실행되는 동안에는 코드 영역 내용을 변경할 수 없다.<br>

## 2.2.3 데이터 영역: 모든 스레드가 데이터 영역의 변수에 접근할 수 있다

데이터 영역은 전역 변수가 저장되는 곳이다.<br>
모든 스레드는 전역 변수에 접근할 수 있으므로 어떤 스레드가 전역 변수 값을 변경하면 다른 스레드에서도 변경된 전역 변수 값이 적용된다.<br>

## 2.2.4 힙 영역: 포인터가 핵심이다

힙 영역은 C/C++ 언어에서 malloc 함수와 new 예약어로 요청하는 메모리가 이 영역에 할당된다.<br>
스레드는 포인터를 획득하면 해당 포인터가 가리키는 데이터에 접근할 수 있으므로 힙 영역은 스레드 간 공유 리소스이다.<br>

## 2.2.5 스택 영역: 공유 공간 내 전용 데이터

스레드의 추상화 측면에서 바라보면 스택 영역은 스레드 전용 공간이다.<br>
하지만 실제 구현 측면에서 바라보면 스택 영역은 엄밀하게 격리된 스레드 전용 공간은 아니다. 서로 다른 스레드의 스택 영역 간 보호를 위한 작동 방식이 존재하지 않기 때문이다.<br>
따라서 하나의 스레드가 다른 스레드의 스택 프레임에서 포인터를 가져올 수 있다면 해당 스레드는 다른 스레드의 스택 영역을 직접 읽고 쓸 수 있다.<br>
이처럼 스레드 여러 개가 하나의 프로세스에 속하는 경우에는 하나의 스레드가 다른 스레드의 스택 영역이라고 하더라도 모두 데이터를 읽고 쓸 수 있다.<br>
이로 인해 버그가 발생했을 때는 디버깅을 통해 원인을 찾기 어렵다.<br>

## 2.2.6 동적 링크 라이브러리와 파일

링크: 컴파일 후 최종적으로 실행 파일을 생성하는 단계<br>
- 정적 링크: 종속된 모든 라이브러리가 실행 파일에 포함되어 있는 것
- 동적 링크: 실행 파일에 종속된 라이브러리의 코드와 데이터 포함 X, 실행 중 혹은 시작할 때 링크 과정이 완료되어야 한다<br>
링크를 위한 데이터와 코드를 스택 영역과 힙 영역 중간에 있는 여유 공간에 배치하면 프로세스 내의 모든 스레드가 동적 라이브러리의 코드와 데이터를 사용할 수 있다.<br><br>

프로그램이 동작 중에 특정 파일을 열면 프로세스 주소 공간에 열린 파일 정보도 저장된다.<br>
프로세스가 연 파일 정보는 모든 스레드에서 사용할 수 있는 스레드 간 공유 리소스이다.<br>

## 2.2.7 스레드 전용 저장소

스레드 전용 저장소에 저장되는 변수는 다음과 같은 2가지 의미가 있다.<br>
1. 이 영역에 저장된 변수는 모든 스레드에서 접근 가능
2. 변수의 인스턴스는 각각의 스레드에 속하므로 하나의 스레드에서 변수 값을 변경해도 다른 스레드에 반영 X<br><br>

```__thread int a = 1```처럼 앞에 ```__thread```를 붙여 전역 변수를 스레드 전용 저장소에 넣을 수 있다.<br>
이렇게 스레드 전용 저장소를 사용하면 각각의 스레드에서 독점적으로 변수를 사용할 수 있다.<br>
즉, 이 변수들은 모든 스레드에서 접근할 수 있지만 해당 변수는 초기화한 후 각각의 스레드가 복사본을 가지게 되며, 다른 스레드에 영향을 미치지 않는다.<br>